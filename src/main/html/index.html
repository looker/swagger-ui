<!DOCTYPE html>
<html>
<head>
  <title>Looker API</title>
  <link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'/>
  <link href='css/reset.css' media='screen' rel='stylesheet' type='text/css'/>
  <link href='css/screen.css' media='screen' rel='stylesheet' type='text/css'/>
  <link href='css/reset.css' media='print' rel='stylesheet' type='text/css'/>
  <link href='css/screen.css' media='print' rel='stylesheet' type='text/css'/>
  <script type="text/javascript" src="lib/shred.bundle.js"></script>
  <script src='lib/jquery-1.8.0.min.js' type='text/javascript'></script>
  <script src='lib/jquery.slideto.min.js' type='text/javascript'></script>
  <script src='lib/jquery.wiggle.min.js' type='text/javascript'></script>
  <script src='lib/jquery.ba-bbq.min.js' type='text/javascript'></script>
  <script src='lib/handlebars-1.0.0.js' type='text/javascript'></script>
  <script src='lib/underscore-min.js' type='text/javascript'></script>
  <script src='lib/backbone-min.js' type='text/javascript'></script>
  <script src='lib/swagger.js' type='text/javascript'></script>
  <script src='lib/swagger-client.js' type='text/javascript'></script>
  <script src='swagger-ui.js' type='text/javascript'></script>
  <script src='lib/highlight.7.3.pack.js' type='text/javascript'></script>
  <script src='lib/marked.js' type='text/javascript'></script>

  <!-- enabling this will enable oauth2 implicit scope support -->
  <script src='lib/swagger-oauth.js' type='text/javascript'></script>
  <script type="text/javascript">
    const DEFAULT_SWAGGER_URL = "/api/3.0/swagger.json"

    $(function () {
      var url = window.location.search.match(/url=([^&]+)/);
      if (url && url.length > 1) {
        url = url[1];
      } else {
        // url = "http://petstore.swagger.wordnik.com/v2/swagger.json";
        url = DEFAULT_SWAGGER_URL;
      }

      marked.setOptions({
        renderer: new marked.Renderer(),
        tables: true,
        breaks: true,
        pedantic: false,
        sanitize: false,
        smartLists: true,
        smartypants: false
      });

      window.swaggerUi = new SwaggerUi({
        url: url,
        dom_id: "swagger-ui-container",
        supportedSubmitMethods: ['get', 'post', 'put', 'patch', 'delete'],
        onComplete: function(swaggerApi, swaggerUi){
          log("Loaded SwaggerUI");
          $('pre code').each(function(i, e) {
            hljs.highlightBlock(e)
          });
        },
        onFailure: function(data) {
          log("Unable to Load SwaggerUI");
          window.swaggerUi.showMessage(data+"<br>Please login with a valid API3 key and press 'Load'.")
        },
        docExpansion: "none",
        sorter : "alpha"
      });

      setInterval(function(){window.updateLoginButton()}, 5000);
      $("#log_in_or_out").mouseenter(function(){window.updateLoginButton()});

      window.swaggerUi.load();
  });
  </script>

  <script type="text/javascript">
    var access_token = null
    var access_token_expires = null


    function updateLoginButton()
    {
      $("#log_in_or_out").prop('value', (isLoggedIn() ? 'Logout' : 'Login'));
    }

    function setAuth(token, expires)
    {
      access_token = token
      access_token_expires = expires
      window.authorizations.add("token", new ApiKeyAuthorization("Authorization", "token "+token, "header"));
      updateLoginButton()
    }

    function clearAuth()
    {
      access_token = null
      access_token_expires = null
      window.authorizations.remove("token")
      updateLoginButton()
    }

    function isLoggedIn()
    {
      return !!access_token && !!access_token_expires && (access_token_expires.getTime() > new Date().getTime())
    }

    function authHeader(access_token)
    {
      return {Authorization: "token "+access_token}
    }

    function logout()
    {
      if(isLoggedIn())
      {
        $.ajax({
          url: '/logout',
          type: 'DELETE',
          headers: authHeader(access_token),
          success: function(data) {
            console.log("logout succeeded")
          },
          error: function(err) {
            console.log("logout FAILED")
            console.log({status: err.status, responseText: err.responseText})
          }
        })
      }
      clearAuth()
    }

    function login(client_id, client_secret)
    {
      if(isLoggedIn())
        return

      clearAuth()

      $.ajax({
        url: '/login',
        type: 'POST',
        data: {client_id: client_id, client_secret: client_secret},
        success: function(data) {
          var access_token = data.access_token
          var access_token_expires = new Date(new Date().getTime() + (data.expires_in * 1000));

          // console.log({access_token: access_token, access_token_expires: access_token_expires})
          setAuth(access_token, access_token_expires)

          console.log("login succeeded")
        },
        error: function(err) {
          console.log("login FAILED")
          console.log({status: err.status, responseText: err.responseText})
          alert("Login failed...\n"+err.status+"\n"+err.responseText);
        }
      })
    }

    function loginOrOut()
    {
      if(isLoggedIn())
        logout()
      else
      {
        client_id = $('#client_id').val()
        client_secret = $('#client_secret').val()
        var reason = "";
        reason += client_id ? '' : 'client_id is required\n'
        reason += client_secret ? '' : 'client_secret is required\n'
        if (reason != "")
          alert(reason);
        else
          login(client_id, client_secret)
      }
      return false;
    }

    function changeLanguage()
    {
      $(".http_method").toggle();
      $(".path").toggle();
      $(".nickname").toggle();
      $("#change_language").prop('value', $('#change_language').val() == 'REST' ? 'Ruby' : 'REST');
      return false;
    }

    function loadSwagger()
    {
      window.swaggerUi.headerView.trigger('update-swagger-ui', {url: DEFAULT_SWAGGER_URL})
      return false;
    }

  </script>

</head>

<body class="swagger-section">

<!--
<div id='header'>
  <div class="swagger-ui-wrap">
    <a id="logo" href="www.looker.com">Looker</a>
    <form id='api_selector'>
      <div class='input'><input placeholder="http://example.com/api" id="input_baseUrl" name="baseUrl" type="text"/></div>
      <div class='input'><input placeholder="api_key" id="input_apiKey" name="apiKey" type="text"/></div>
      <div class='input'><a id="explore" href="#">Explore</a></div>
    </form>
  </div>
</div>
 -->

  <div id="message-bar" class="swagger-ui-wrap">&nbsp;</div>

  <div id="credentials_div">
    <form id='credentials' action="" onsubmit="return loginOrOut();">
      Login with API3 key:<br>
      <label for="client_id">client_id:</label> <input type="text" name="client_id" id="client_id"><br>
      <label for="client_secret">client_secret:</label> <input type="password" name="client_secret" id="client_secret"><br>
      <input type="submit" name='log_in_or_out' id='log_in_or_out' value="Login">
    </form>

    <div id="language_div">
      <form id='load' action="" onsubmit="return loadSwagger();">
        <input type="submit" name='load_swagger' id='load_swagger' value="Load">
      </form>
      <form id='language' action="" onsubmit="return changeLanguage();">
        <input type="submit" name='change_language' id='change_language' value="REST">
      </form>
    </div>

  </div>

  <div id="swagger-ui-container" class="swagger-ui-wrap"></div>
</body>
</html>
